#!/usr/bin/env bash
set -euo pipefail

WAYBAR_CURSOR_INVISIBLE_SIGNAL="${WAYBAR_CURSOR_INVISIBLE_SIGNAL:-14}"

notify() {
  local message="$1"
  if command -v notify-send >/dev/null 2>&1; then
    notify-send "Mouse pointer" "$message" -t 1800 || true
  fi
}

refresh_waybar() {
  pkill -RTMIN+"$WAYBAR_CURSOR_INVISIBLE_SIGNAL" waybar >/dev/null 2>&1 || true
}

usage() {
  printf '%s\n' "Usage: $(basename "$0") [toggle|on|off|status]" >&2
}

read_mode() {
  local output int_value set_value

  if ! output="$(hyprctl getoption cursor:invisible 2>/dev/null)"; then
    printf '%s' "unknown"
    return 1
  fi

  int_value="$(printf '%s\n' "$output" | sed -n 's/^int:[[:space:]]*//p' | head -n 1)"
  case "$int_value" in
    1)
      printf '%s' "on"
      return 0
      ;;
    0)
      printf '%s' "off"
      return 0
      ;;
  esac

  set_value="$(printf '%s\n' "$output" | sed -n 's/^set:[[:space:]]*//p' | head -n 1)"
  case "$set_value" in
    true|1)
      printf '%s' "on"
      return 0
      ;;
    false|0)
      printf '%s' "off"
      return 0
      ;;
    *)
      printf '%s' "unknown"
      return 1
      ;;
  esac
}

set_mode() {
  local target="$1"
  local value
  case "$target" in
    on) value="1" ;;
    off) value="0" ;;
    *) return 2 ;;
  esac

  local output
  local status
  output="$(hyprctl keyword cursor:invisible "$value" 2>&1)" && status=0 || status=$?
  if (( status == 0 )) && [[ -z "$output" || "$output" == ok* ]]; then
    return 0
  fi

  if [[ "$target" == "on" ]]; then
    hyprctl keyword cursor:invisible true >/dev/null 2>&1 && return 0
  else
    hyprctl keyword cursor:invisible false >/dev/null 2>&1 && return 0
  fi
  return 1
}

action="${1:-toggle}"
case "$action" in
  toggle|on|off|status) ;;
  *)
    usage
    exit 2
    ;;
esac

if ! command -v hyprctl >/dev/null 2>&1; then
  notify "hyprctl not found"
  exit 1
fi

if [[ "$action" == "status" ]]; then
  read_mode
  exit 0
fi

current="unknown"
current="$(read_mode 2>/dev/null || true)"
if [[ "$action" == "toggle" ]]; then
  if [[ "$current" == "on" ]]; then
    action="off"
  else
    action="on"
  fi
fi

rc=0
if set_mode "$action"; then
  if [[ "$action" == "on" ]]; then
    notify "Hidden"
  else
    notify "Visible"
  fi
else
  notify "Failed to switch pointer visibility"
  rc=1
fi

refresh_waybar
exit "$rc"
